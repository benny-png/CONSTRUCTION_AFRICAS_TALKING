# Construction Management SaaS Backend API

A FastAPI-based backend API for a construction management SaaS platform that helps construction companies manage projects efficiently. This API serves multiple stakeholders: project managers, workers, and end users (clients).

## Features

- **User Management**: Register and authenticate users with role-based access control
- **Project Management**: Create projects and submit progress reports
- **Inventory Management**: Track materials and assets in the inventory
- **Inventory Requests**: Workers can request inventory items needed for their tasks
- **Material Usage**: Track daily material usage for efficient resource allocation
- **Expense Tracking**: Monitor expenses and upload receipts for transactions
- **Financial Verification**: Verify expense receipts match recorded amounts for financial accuracy
- **Analytics**: Get summary statistics for projects
- **AI Assistance**: AI-powered tools for managers, workers, and clients
  - Project planning advice for managers
  - Construction technique help for workers
  - Project progress analysis for clients
  - Expense receipt verification with financial accuracy checks

## Technical Stack

- **Backend Framework**: FastAPI
- **Database**: MongoDB with proper datetime handling
- **Authentication**: JWT tokens
- **Documentation**: Swagger UI (auto-generated by FastAPI)
- **File Storage**: Local directory for receipts and images
- **AI Integration**: OpenRouter API for AI features with Gemini-2.0-Flash model
- **Image Processing**: Base64 encoding for image analysis

## Project Structure

```
construction_management/
├── main.py              # FastAPI app entry point
├── routers/             # API route handlers
│   ├── auth.py         # Authentication endpoints
│   ├── users.py        # User management endpoints
│   ├── projects.py     # Project management endpoints
│   ├── inventory.py    # Inventory management endpoints
│   ├── requests.py     # Inventory request endpoints
│   ├── expenses.py     # Expense tracking endpoints
│   ├── material_usage.py # Material usage tracking endpoints
│   ├── notifications.py # Notifications endpoints
│   ├── ai_assistance.py # AI assistance endpoints
├── models/              # Pydantic models
│   ├── user.py
│   ├── project.py
│   ├── inventory.py
│   ├── expense.py
│   ├── request.py
│   ├── material_usage.py
│   ├── notification.py
├── database/            # MongoDB connection and queries
│   ├── db.py
│   ├── operations.py
│   ├── auth.py
├── uploads/             # Directory for storing uploaded files
│   ├── receipts/       # Receipt images
│   ├── inventory/      # Inventory item images
│   ├── temp/           # Temporary files for image processing
├── logging_config.py    # Logging configuration
├── requirements.txt     # Project dependencies
├── .env                 # Environment variables (not tracked in git)
```

## Installation and Setup

1. Clone the repository:
   ```
   git clone <repository-url>
   cd construction_management
   ```

2. Create a virtual environment and activate it:
   ```
   python -m venv .venv
   source .venv/bin/activate  # On Windows: .venv\Scripts\activate
   ```

3. Install dependencies:
   ```
   pip install -r requirements.txt
   ```

4. Create a `.env` file with your configuration:
   ```
   # MongoDB connection string
   MONGO_CONNECTION_STRING="your-mongo-connection-string"
   DATABASE_NAME="construction_management"

   # JWT Settings
   SECRET_KEY="your-secret-key-for-jwt-tokens"
   ALGORITHM="HS256"
   ACCESS_TOKEN_EXPIRE_MINUTES=30

   # OpenRouter API Key (for AI features)
   OPENROUTER_API_KEY="your-openrouter-api-key"
   SITE_URL="https://your-site-url.com"
   SITE_NAME="Construction Management System" 
   ```

5. Run the API:
   ```
   uvicorn main:app --reload
   ```

6. Access the API documentation at `http://localhost:8000/docs`

## API Endpoints

The API provides the following endpoint categories:

- **Authentication** (`/auth/*`): User registration, login, and token management
- **Users** (`/users/*`): User management, filtering by roles (clients, managers, workers)
- **Projects** (`/projects/*`): Project creation, management, and progress tracking
- **Inventory** (`/inventory/*`): Inventory item management
- **Requests** (`/requests/*`): Worker requests for inventory items
- **Expenses** (`/expenses/*`): Expense tracking and receipt management
- **Material Usage** (`/material-usage/*`): Tracking material consumption
- **Notifications** (`/notifications/*`): User notifications
- **AI Assistance** (`/ai/*`): AI-powered tools and analysis

For detailed endpoint specifications, refer to the Swagger UI documentation available at `/docs` when the API is running.

## User Management Features

The API includes several user management endpoints:

### Get All Users (Manager only)
```
GET /users/
```
Retrieve a list of all users in the system.

### Get User by ID (Manager only)
```
GET /users/{user_id}
```
Retrieve a specific user by their ID.

### Update User (Manager only)
```
PUT /users/{user_id}
```
Update an existing user's profile (name, email, phone, role, etc).

### Delete User (Manager only)
```
DELETE /users/{user_id}
```
Delete a user from the system.

### Get Users by Role (Any authenticated user)
```
GET /users/clients
GET /users/managers
GET /users/workers
```
These endpoints allow filtering users by their role, accessible to any authenticated user.

## AI Assistance Features

The API includes several AI-powered features:

### Project Advice for Managers
```
POST /ai/manager/project-advice
```
Managers can get AI-generated advice for project planning, problem-solving, and best practices. The advice can be contextualized with specific project details by providing a project_id.

### Construction Help for Workers
```
POST /ai/worker/construction-help
```
Workers can get AI assistance with construction techniques, including the ability to upload images of construction issues. This helps workers solve technical problems on-site.

### Progress Analysis for Clients
```
POST /ai/client/progress-analysis
```
Clients can ask questions about their project's progress and get clear, non-technical explanations of complex construction processes and timelines.

### Financial Verification
```
POST /ai/verify-transaction
```
This endpoint analyzes expense receipts and verifies if the amounts shown match the amounts recorded in the system. It provides a detailed financial accuracy verification with three possible results:
- **MATCH**: The receipt amount matches the recorded amount
- **DISCREPANCY**: There is a difference between the receipt amount and recorded amount
- **NEEDS_REVIEW**: The AI couldn't make a clear determination

The AI carefully examines the receipt image to extract the total amount and compares it with the expense record in the database, enhancing financial accountability and trust.

## Role-Based Access Control

The API enforces role-based access control with three primary roles:

1. **Manager**: Full access to create and manage projects, inventory, expenses, and view all data.
2. **Worker**: Can view assigned projects, request inventory items, and report material usage.
3. **Client**: Can view their own projects, track progress, and verify expenses.

## Error Handling

All endpoints follow a consistent error handling pattern and return appropriate HTTP status codes:

- **400**: Bad Request - Invalid input data
- **401**: Unauthorized - Missing or invalid authentication
- **403**: Forbidden - Not enough permissions
- **404**: Not Found - Resource not found
- **500**: Internal Server Error - Server-side error

## Recent Updates

1. **MongoDB Date Handling**: Fixed date encoding issues by converting Python date objects to datetime objects
2. **User Management API**: Added comprehensive user management endpoints with proper documentation
3. **Enhanced Financial Verification**: Updated the transaction verification feature to focus on financial accuracy
4. **Improved API Documentation**: Added detailed parameter documentation in the Swagger UI for all endpoints
5. **AI Model Upgrade**: Using Google's Gemini-2.0-Flash model through OpenRouter for improved AI responses

## License

This project is licensed under the MIT License - see the LICENSE file for details. 