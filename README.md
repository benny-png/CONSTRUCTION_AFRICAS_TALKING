# Construction Management SaaS Backend API

A FastAPI-based backend API for a construction management SaaS platform that helps construction companies manage projects efficiently. This API serves multiple stakeholders: project managers, workers, and end users (clients).

## Features

- **User Management**: Register and authenticate users with role-based access control
- **Project Management**: Create projects and submit progress reports
- **Inventory Management**: Track materials and assets in the inventory
- **Inventory Requests**: Workers can request inventory items needed for their tasks
- **Material Usage**: Track daily material usage for efficient resource allocation
- **Expense Tracking**: Monitor expenses and upload receipts for transactions
- **Receipt Verification**: Clients can verify the authenticity of expenses by viewing receipts
- **Analytics**: Get summary statistics for projects

## Technical Stack

- **Backend Framework**: FastAPI
- **Database**: MongoDB
- **Authentication**: JWT tokens
- **Documentation**: Swagger UI (auto-generated by FastAPI)
- **File Storage**: Local directory for receipts

## Project Structure

```
construction_management/
├── main.py              # FastAPI app entry point
├── routers/             # API route handlers
│   ├── auth.py         # Authentication endpoints
│   ├── projects.py     # Project management endpoints
│   ├── inventory.py    # Inventory management endpoints
│   ├── requests.py     # Inventory request endpoints
│   ├── expenses.py     # Expense tracking endpoints
│   ├── material_usage.py # Material usage tracking endpoints
│   ├── notifications.py # Notifications endpoints
├── models/              # Pydantic models
│   ├── user.py
│   ├── project.py
│   ├── inventory.py
│   ├── expense.py
│   ├── request.py
│   ├── material_usage.py
│   ├── notification.py
├── database/            # MongoDB connection and queries
│   ├── db.py
│   ├── operations.py
│   ├── auth.py
├── uploads/             # Directory for storing receipt files
│   ├── receipts/
├── requirements.txt     # Project dependencies
```

## Installation and Setup

1. Clone the repository:
   ```
   git clone <repository-url>
   cd construction_management
   ```

2. Install dependencies:
   ```
   pip install -r requirements.txt
   ```

3. Run the API:
   ```
   uvicorn main:app --reload
   ```

4. Access the API documentation at `http://localhost:8000/docs`

## API Endpoints with Examples

### Authentication

#### Register User

- **Endpoint**: `POST /auth/register`
- **Description**: Register a new user in the system
- **Example Request**:
  ```json
  {
    "username": "john_doe",
    "password": "password123",
    "email": "john.doe@example.com",
    "role": "manager"
  }
  ```
- **Example Response**:
  ```json
  {
    "username": "john_doe",
    "email": "john.doe@example.com",
    "role": "manager",
    "id": "60d21b4667d0d8992e610c85",
    "created_at": "2023-08-15T10:30:45.123Z"
  }
  ```

#### Login

- **Endpoint**: `POST /auth/login`
- **Description**: Authenticate user and get JWT token
- **Example Request**:
  ```json
  {
    "username": "john_doe",
    "password": "password123"
  }
  ```
- **Example Response**:
  ```json
  {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "bearer"
  }
  ```

#### Get Current User Info

- **Endpoint**: `GET /auth/me`
- **Description**: Get current user info based on JWT token
- **Example Response**:
  ```json
  {
    "username": "john_doe",
    "email": "john.doe@example.com",
    "role": "manager",
    "id": "60d21b4667d0d8992e610c85",
    "created_at": "2023-08-15T10:30:45.123Z"
  }
  ```

### Project Management

#### Create Project

- **Endpoint**: `POST /projects`
- **Description**: Create a new construction project (Manager only)
- **Example Request**:
  ```json
  {
    "name": "Kindaruma Heights Apartment Building",
    "description": "Construction of a 15-floor luxury apartment building",
    "location": "Kindaruma Road, Nairobi",
    "budget": 150000000,
    "start_date": "2023-09-01",
    "end_date": "2025-03-31",
    "client_id": "60d21b4667d0d8992e610c85"
  }
  ```
- **Example Response**:
  ```json
  {
    "id": "61a23c4567d0d8992e610d96",
    "name": "Kindaruma Heights Apartment Building",
    "description": "Construction of a 15-floor luxury apartment building",
    "location": "Kindaruma Road, Nairobi",
    "budget": 150000000,
    "start_date": "2023-09-01",
    "end_date": "2025-03-31",
    "client_id": "60d21b4667d0d8992e610c85",
    "status": "planning",
    "created_at": "2023-08-15T14:25:30.123Z",
    "progress_reports": []
  }
  ```

#### Get Project Details

- **Endpoint**: `GET /projects/{project_id}`
- **Description**: Get details of a specific project
- **Example Response**:
  ```json
  {
    "id": "61a23c4567d0d8992e610d96",
    "name": "Kindaruma Heights Apartment Building",
    "description": "Construction of a 15-floor luxury apartment building",
    "location": "Kindaruma Road, Nairobi",
    "budget": 150000000,
    "start_date": "2023-09-01",
    "end_date": "2025-03-31",
    "client_id": "60d21b4667d0d8992e610c85",
    "status": "in_progress",
    "created_at": "2023-08-15T14:25:30.123Z",
    "progress_reports": [
      {
        "report_date": "2023-10-01",
        "description": "Completed foundation work and started framing",
        "percentage_complete": 25.5,
        "created_at": "2023-10-01T08:15:30.123Z"
      }
    ]
  }
  ```

#### Submit Progress Report

- **Endpoint**: `POST /projects/{project_id}/progress`
- **Description**: Submit a progress report for a project (Manager only)
- **Example Request**:
  ```json
  {
    "report_date": "2023-10-01",
    "description": "Completed foundation work and started framing",
    "percentage_complete": 25.5
  }
  ```
- **Example Response**:
  ```json
  {
    "message": "Progress report submitted successfully"
  }
  ```

#### Get Project Summary

- **Endpoint**: `GET /projects/{project_id}/summary`
- **Description**: Get project summary statistics (Manager & Client)
- **Example Response**:
  ```json
  {
    "project_name": "Kindaruma Heights Apartment Building",
    "total_expenses": 35250000,
    "material_usage": {
      "cement": 2500,
      "steel": 1800,
      "sand": 3500
    },
    "progress_percentage": 25.5,
    "start_date": "2023-09-01",
    "end_date": "2025-03-31",
    "expenses_count": 15,
    "material_usage_count": 25
  }
  ```

### Inventory Management

#### Add Inventory Item

- **Endpoint**: `POST /inventory`
- **Description**: Add new inventory item (Manager only)
- **Request Format**: `multipart/form-data`
- **Form Fields**:
  - `name`: "Portland Cement"
  - `quantity`: 500
  - `unit`: "bags"
  - `project_id`: "61a23c4567d0d8992e610d96"
  - `description`: "50kg bags of Portland cement" (optional)
  - `cost_per_unit`: 750 (optional)
  - `item_image`: [File Upload] (optional)
- **Example Response**:
  ```json
  {
    "id": "62b34d5678e1f9ab3c721e07",
    "name": "Portland Cement",
    "description": "50kg bags of Portland cement",
    "quantity": 500,
    "unit": "bags",
    "cost_per_unit": 750,
    "project_id": "61a23c4567d0d8992e610d96",
    "image_url": "/inventory-images/e672f890-b4f2-4dc6-f054-1234567890ab.jpg",
    "created_at": "2023-08-16T09:45:20.123Z"
  }
  ```

#### Get Project Inventory

- **Endpoint**: `GET /inventory/{project_id}`
- **Description**: View inventory for a project (Manager only)
- **Example Response**:
  ```json
  [
    {
      "id": "62b34d5678e1f9ab3c721e07",
      "name": "Portland Cement",
      "description": "50kg bags of Portland cement",
      "quantity": 425,
      "unit": "bags",
      "cost_per_unit": 750,
      "project_id": "61a23c4567d0d8992e610d96",
      "image_url": "/inventory-images/e672f890-b4f2-4dc6-f054-1234567890ab.jpg",
      "created_at": "2023-08-16T09:45:20.123Z"
    },
    {
      "id": "62b34d5678e1f9ab3c721e08",
      "name": "Steel Rebar",
      "description": "12mm steel reinforcement bars",
      "quantity": 350,
      "unit": "pieces",
      "cost_per_unit": 1200,
      "project_id": "61a23c4567d0d8992e610d96",
      "image_url": null,
      "created_at": "2023-08-16T10:15:40.123Z"
    }
  ]
  ```

#### Get Inventory Item Image

- **Endpoint**: `GET /inventory/image/{image_filename}`
- **Description**: Get the image file for an inventory item (Manager only)
- **Response**: The actual image file

### Inventory Requests

#### Request Inventory Item

- **Endpoint**: `POST /requests`
- **Description**: Request inventory item (Worker only)
- **Example Request**:
  ```json
  {
    "item_name": "Portland Cement",
    "quantity": 25,
    "project_id": "61a23c4567d0d8992e610d96",
    "manager_id": "60d21b4667d0d8992e610c85",
    "reason": "Needed for ground floor column casting"
  }
  ```
- **Example Response**:
  ```json
  {
    "id": "63c45e6789f2f0ba4d832f18",
    "item_name": "Portland Cement",
    "quantity": 25,
    "project_id": "61a23c4567d0d8992e610d96",
    "worker_id": "60e32c5778a1a9bb3d721f96",
    "manager_id": "60d21b4667d0d8992e610c85",
    "reason": "Needed for ground floor column casting",
    "status": "pending",
    "created_at": "2023-08-18T11:35:25.123Z"
  }
  ```

#### Get Project Requests

- **Endpoint**: `GET /requests/{project_id}`
- **Description**: View incoming requests (Manager only)
- **Example Response**:
  ```json
  [
    {
      "id": "63c45e6789f2f0ba4d832f18",
      "item_name": "Portland Cement",
      "quantity": 25,
      "project_id": "61a23c4567d0d8992e610d96",
      "worker_id": "60e32c5778a1a9bb3d721f96",
      "manager_id": "60d21b4667d0d8992e610c85",
      "reason": "Needed for ground floor column casting",
      "status": "pending",
      "created_at": "2023-08-18T11:35:25.123Z"
    }
  ]
  ```

### Material Usage

#### Log Material Usage

- **Endpoint**: `POST /material-usage`
- **Description**: Log daily material usage (Manager only)
- **Example Request**:
  ```json
  {
    "item_name": "Portland Cement",
    "quantity_used": 15,
    "project_id": "61a23c4567d0d8992e610d96",
    "location": "Ground floor columns",
    "date": "2023-08-19"
  }
  ```
- **Example Response**:
  ```json
  {
    "id": "64d56f789af3f1cb5e943g29",
    "item_name": "Portland Cement",
    "quantity_used": 15,
    "project_id": "61a23c4567d0d8992e610d96",
    "location": "Ground floor columns",
    "date": "2023-08-19",
    "created_at": "2023-08-19T16:40:15.123Z"
  }
  ```

#### Get Material Usage

- **Endpoint**: `GET /material-usage/{project_id}`
- **Description**: View material usage for a project (Manager only)
- **Example Response**:
  ```json
  [
    {
      "id": "64d56f789af3f1cb5e943g29",
      "item_name": "Portland Cement",
      "quantity_used": 15,
      "project_id": "61a23c4567d0d8992e610d96",
      "location": "Ground floor columns",
      "date": "2023-08-19",
      "created_at": "2023-08-19T16:40:15.123Z"
    }
  ]
  ```

### Expense Tracking

#### Add Expense with Receipt

- **Endpoint**: `POST /expenses`
- **Description**: Add expense with receipt (Manager only)
- **Request Format**: `multipart/form-data`
- **Form Fields**:
  - `amount`: 12500.75
  - `description`: "Purchase of waterproofing materials"
  - `date`: "2023-08-20"
  - `project_id`: "61a23c4567d0d8992e610d96"
  - `receipt_file`: [File Upload]
- **Example Response**:
  ```json
  {
    "id": "65e67g890bg4f2dc6f054h30",
    "amount": 12500.75,
    "description": "Purchase of waterproofing materials",
    "date": "2023-08-20",
    "project_id": "61a23c4567d0d8992e610d96",
    "receipt_url": "/receipts/e672f890-b4f2-4dc6-f054-1234567890ab.jpg",
    "verified": "pending",
    "created_at": "2023-08-20T13:50:10.123Z"
  }
  ```

#### Get Project Expenses

- **Endpoint**: `GET /expenses/{project_id}`
- **Description**: View expenses for a project (Manager & Client)
- **Example Response**:
  ```json
  [
    {
      "id": "65e67g890bg4f2dc6f054h30",
      "amount": 12500.75,
      "description": "Purchase of waterproofing materials",
      "date": "2023-08-20",
      "project_id": "61a23c4567d0d8992e610d96",
      "receipt_url": "/receipts/e672f890-b4f2-4dc6-f054-1234567890ab.jpg",
      "verified": "pending",
      "created_at": "2023-08-20T13:50:10.123Z"
    }
  ]
  ```

#### Verify Expense

- **Endpoint**: `PATCH /expenses/{expense_id}/verify`
- **Description**: Verify expense authenticity (Client only)
- **Example Request**:
  ```json
  {
    "status": "approved"
  }
  ```
- **Example Response**:
  ```json
  {
    "message": "Expense verification status updated to approved"
  }
  ```

### Notifications

#### Get User Notifications

- **Endpoint**: `GET /notifications/{user_id}`
- **Description**: Get notifications for a user
- **Example Response**:
  ```json
  [
    {
      "id": "66f78h901ch5f3ed7g165i41",
      "user_id": "60d21b4667d0d8992e610c85",
      "type": "inventory_request",
      "message": "New inventory request for Portland Cement",
      "created_at": "2023-08-18T11:36:25.123Z",
      "read": false,
      "request_id": "63c45e6789f2f0ba4d832f18"
    }
  ]
  ```

#### Mark Notification as Read

- **Endpoint**: `PATCH /notifications/{notification_id}/read`
- **Description**: Mark a notification as read
- **Example Response**:
  ```json
  {
    "message": "Notification marked as read"
  }
  ```

## User Roles

- **Project Manager**: Full access to project management, inventory, expenses, and receipts
- **Worker**: Can only request inventory and view assigned projects
- **End User (Client)**: Can only view project progress, expenses, and verify receipts

## License

[MIT License](LICENSE) 